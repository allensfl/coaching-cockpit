// Phase progression logic - Enhanced
        function checkPhaseProgression(aiResponse, userMessage) {
            // Count messages in current phase
            const messagesInPhase = sessionData.messages.filter(m => m.phase === currentPhase).length;
            
            // Detect phase completion signals in AI response
            const progressionSignals = [
                'nächste phase',
                'weitergehen',
                'vertiefen',
                'nächster schritt',
                'phase.*abgeschlossen',
                'können wir.*fortfahren'
            ];
            
            const hasProgressionSignal = progressionSignals.some(signal => 
                aiResponse.toLowerCase().match(new RegExp(signal))
            );
            
            // Progress conditions:
            // 1. Enough messages in phase (4-6 depending on phase)
            // 2. AI suggests progression
            // 3. Not already in final phase
            const minMessages = currentPhase <= 2 ? 4 : 5; // First phases shorter
            
            if ((messagesInPhase >= minMessages || hasProgressionSignal) && currentPhase < 8) {
                setTimeout(() => {
                    progressToNextPhase();
                }, 2000);
            }
        }<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KI Coaching Session - KI Online Coach</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .chat-container {
            display: flex;
            height: 100vh;
            background: white;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.1);
        }
        
        /* Sidebar */
        .chat-sidebar {
            width: 320px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 25px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        .chat-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }
        
        .chat-header {
            position: relative;
            z-index: 1;
        }
        
        .coach-info {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .coach-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .coach-avatar i {
            font-size: 2rem;
            color: white;
        }
        
        .coach-details h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .coach-details p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .online-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .phase-indicator {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .phase-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .phase-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .phase-progress {
            background: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .phase-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 4px;
            transition: width 0.8s ease;
        }
        
        .phase-description {
            font-size: 0.85rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .session-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-top: auto;
            position: relative;
            z-index: 1;
        }
        
        .session-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            display: block;
        }
        
        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
        }
        
        .message {
            max-width: 70%;
            padding: 18px 24px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.6;
            animation: fadeInUp 0.4s ease;
            position: relative;
        }
        
        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .message.ai {
            align-self: flex-start;
            background: white;
            color: #374151;
            border-bottom-left-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        
        .message.ai::before {
            content: '🤖';
            position: absolute;
            top: -8px;
            left: 15px;
            background: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background: white;
            padding: 18px 24px;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
            max-width: 120px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        .typing-dots span:nth-child(3) { animation-delay: 0s; }
        
        .typing-text {
            margin-left: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Input Area */
        .chat-input-container {
            background: white;
            padding: 25px 30px;
            border-top: 1px solid #e5e7eb;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }
        
        .input-group {
            flex: 1;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 60px 15px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            resize: none;
            transition: all 0.3s ease;
            background: #f9fafb;
        }
        
        .chat-input:focus {
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .char-counter {
            position: absolute;
            bottom: 8px;
            right: 15px;
            font-size: 0.75rem;
            color: #9ca3af;
            pointer-events: none;
        }
        
        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .input-hints {
            margin-top: 12px;
            text-align: center;
        }
        
        .input-hints small {
            color: #6b7280;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .error-message {
            background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
            color: #dc2626 !important;
            border: 1px solid #fca5a5 !important;
        }
        
        .error-message::before {
            content: '⚠️' !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
            }
            
            .chat-sidebar {
                width: 100%;
                height: auto;
                padding: 20px;
            }
            
            .coach-info {
                display: flex;
                align-items: center;
                text-align: left;
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .coach-avatar {
                width: 60px;
                height: 60px;
                margin: 0;
            }
            
            .coach-avatar i {
                font-size: 1.5rem;
            }
            
            .phase-indicator {
                margin-bottom: 0;
            }
            
            .session-info {
                display: none;
            }
            
            .chat-messages {
                padding: 20px;
            }
            
            .message {
                max-width: 85%;
            }
            
            .chat-input-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <div class="coach-info">
                    <div class="coach-avatar">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="coach-details">
                        <h3>KI Coach</h3>
                        <p>Dein persönlicher Ruhestandscoach</p>
                        <div class="online-status">
                            <span class="status-dot"></span>
                            Online
                        </div>
                    </div>
                </div>
                
                <!-- Phase Indicator -->
                <div class="phase-indicator">
                    <div class="phase-title">Aktuelle Phase</div>
                    <div class="phase-name" id="phaseName">Phase 1: Standortbestimmung</div>
                    <div class="phase-progress">
                        <div class="phase-progress-bar" id="phaseProgress" style="width: 12.5%"></div>
                    </div>
                    <div class="phase-description" id="phaseDescription">
                        Teile deine aktuelle Situation und Gedanken zum Ruhestand mit mir.
                    </div>
                </div>
            </div>
            
            <!-- Session Info -->
            <div class="session-info">
                <div class="session-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="messageCount">0</span>
                        <span class="stat-label">Nachrichten</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sessionTime">0:00</span>
                        <span class="stat-label">Session</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    🌟 <strong>Herzlich willkommen zu deinem persönlichen Ruhestandscoaching!</strong><br><br>
                    
                    Ich bin dein KI-Coach und begleite dich durch alle 8 Phasen deiner Ruhestandsplanung. Gemeinsam entwickeln wir eine Vision für deinen erfüllten Ruhestand.<br><br>
                    
                    <strong>Erzähle mir gerne:</strong> Was bewegt dich aktuell am meisten beim Thema Ruhestand? Was ist dein Herzenswunsch für diese neue Lebensphase?
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="typing-text">KI Coach denkt nach...</div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <div class="input-group">
                        <textarea 
                            id="chatInput" 
                            class="chat-input"
                            placeholder="Teile deine Gedanken und Gefühle mit mir..."
                            onkeypress="handleKeyPress(event)"
                            oninput="autoResize(this); updateCharCounter()"
                        ></textarea>
                        <div class="char-counter" id="charCounter">0/500</div>
                    </div>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-hints">
                    <small><i class="fas fa-lightbulb"></i> Sei ehrlich und offen - je mehr du teilst, desto besser kann ich dir helfen!</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Session State Management
        let currentPhase = 1;
        let messageCount = 0;
        let sessionStartTime = new Date();
        let userLearningStyle = null; // Will be detected/asked
        let sessionData = {
            messages: [],
            insights: [],
            goals: [],
            emotions: [],
            learningStyle: null,
            userPreferences: {}
        };
        
        // 8-Phasen Ruhestandscoaching System
        const phaseConfig = {
            1: {
                name: "Standortbestimmung",
                description: "Teile deine aktuelle Situation und Gedanken zum Ruhestand mit mir.",
                focus: "Aktuelle Situation, Gedanken und Gefühle zum Ruhestand"
            },
            2: {
                name: "Emotionale Vertiefung", 
                description: "Lass uns deine Gefühle zum Ruhestand genauer erkunden.",
                focus: "Identifikation des zentralen Gefühls beim Thema Ruhestand"
            },
            3: {
                name: "Zielvision",
                description: "Entwickeln wir gemeinsam deine persönliche Vision für den Ruhestand.",
                focus: "Persönliche Vision für den erfüllten Ruhestand"
            },
            4: {
                name: "Ressourcenanalyse",
                description: "Schauen wir uns deine verfügbaren Ressourcen und Stärken an.",
                focus: "Identifikation vorhandener Ressourcen und Stärken"
            },
            5: {
                name: "Hindernisbetrachtung",
                description: "Welche Herausforderungen könnten auf dem Weg auftreten?",
                focus: "Mögliche Hindernisse und Herausforderungen"
            },
            6: {
                name: "Lösungsentwicklung",
                description: "Entwickeln wir konkrete Strategien und Lösungsansätze.",
                focus: "Konkrete Strategien und Lösungsansätze"
            },
            7: {
                name: "Aktionsplanung",
                description: "Erstellen wir deinen persönlichen Aktionsplan.",
                focus: "Konkreter Aktionsplan mit Schritten und Terminen"
            },
            8: {
                name: "Integration & Ausblick",
                description: "Integrieren wir alles und schauen in die Zukunft.",
                focus: "Integration der Erkenntnisse und Ausblick"
            }
        };
        
        // ECHTE API-INTEGRATION - Erweitert für vollständigen Context
        async function generateAIResponse(userMessage) {
            try {
                showTypingIndicator();
                
                // Detect learning style from message
                detectLearningStyle(userMessage);
                
                // Prepare comprehensive context for API
                const enhancedSessionData = {
                    ...sessionData,
                    learningStyle: userLearningStyle,
                    currentPhase: currentPhase,
                    messageCount: messageCount,
                    sessionDuration: Math.floor((new Date() - sessionStartTime) / 1000 / 60), // in minutes
                    recentMessages: sessionData.messages.slice(-5), // Last 5 for context
                    userInsights: sessionData.insights,
                    emotionalState: sessionData.emotions.slice(-3) // Recent emotions
                };
                
                // Call the real OpenAI API with enhanced context
                const response = await fetch('/api/openai-simple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        phase: currentPhase,
                        sessionData: enhancedSessionData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Extract AI response
                const aiResponse = data.response || data.message || "Entschuldigung, ich konnte keine Antwort generieren.";
                
                // Analyze AI response for insights
                extractInsights(aiResponse, userMessage);
                
                // Check for phase progression
                checkPhaseProgression(aiResponse, userMessage);
                
                return aiResponse;
                
            } catch (error) {
                console.error('API Error:', error);
                
                // Fallback to offline responses
                return generateFallbackResponse(userMessage);
                
            } finally {
                hideTypingIndicator();
            }
        }
        
        // Fallback responses for offline/error scenarios
        function generateFallbackResponse(userMessage) {
            const fallbackResponses = {
                1: [
                    "Danke, dass du das mit mir teilst. Das klingt wie ein wichtiger Schritt für dich. Kannst du mir mehr über deine Gefühle dabei erzählen?",
                    "Ich verstehe deine Gedanken. Der Ruhestand bringt viele Veränderungen mit sich. Was beschäftigt dich am meisten?",
                    "Das ist eine sehr persönliche Reflektion. Magst du mir erzählen, was dir dabei durch den Kopf geht?"
                ],
                2: [
                    "Diese Gefühle sind völlig normal und verständlich. Kannst du das Gefühl vielleicht mit einem Bild oder einer Farbe beschreiben?",
                    "Emotionen beim Übergang in den Ruhestand sind sehr wichtig. Wie würdest du dieses Gefühl beschreiben?",
                    "Danke für deine Offenheit. Welches Gefühl begleitet dich am stärksten bei diesem Thema?"
                ],
                3: [
                    "Eine Vision zu entwickeln ist ein kraftvoller Schritt. Wie stellst du dir deinen idealen Ruhestand vor?",
                    "Träume und Visionen geben Richtung. Was wäre für dich ein erfüllter Ruhestand?",
                    "Lass uns gemeinsam an deiner Vision arbeiten. Was siehst du vor dir, wenn du an deinen Ruhestand denkst?"
                ]
            };
            
            const responses = fallbackResponses[currentPhase] || fallbackResponses[1];
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Learning Style Detection
        function detectLearningStyle(userMessage) {
            if (userLearningStyle) return; // Already detected
            
            const message = userMessage.toLowerCase();
            
            // Visual indicators
            const visualKeywords = ['sehen', 'zeigen', 'bild', 'vorstellen', 'visualisieren', 'schauen', 'betrachten', 'aussehen'];
            // Auditory indicators  
            const auditoryKeywords = ['hören', 'sprechen', 'erzählen', 'diskutieren', 'gespräch', 'reden', 'zuhören'];
            // Kinesthetic indicators
            const kinestheticKeywords = ['fühlen', 'spüren', 'erleben', 'machen', 'handeln', 'ausprobieren', 'bewegen'];
            
            let visualScore = visualKeywords.filter(word => message.includes(word)).length;
            let auditoryScore = auditoryKeywords.filter(word => message.includes(word)).length;
            let kinestheticScore = kinestheticKeywords.filter(word => message.includes(word)).length;
            
            if (visualScore > auditoryScore && visualScore > kinestheticScore) {
                userLearningStyle = 'visuell';
            } else if (auditoryScore > kinestheticScore) {
                userLearningStyle = 'auditiv';
            } else if (kinestheticScore > 0) {
                userLearningStyle = 'kinästhetisch';
            }
            
            if (userLearningStyle) {
                sessionData.learningStyle = userLearningStyle;
                console.log(`Learning style detected: ${userLearningStyle}`);
            }
        }
        
        // Extract insights from conversation
        function extractInsights(aiResponse, userMessage) {
            // Detect emotional keywords in user message
            const emotionKeywords = {
                'angst': ['angst', 'sorge', 'befürchtung', 'unsicherheit'],
                'freude': ['freude', 'begeisterung', 'vorfreude', 'glück'],
                'trauer': ['trauer', 'verlust', 'abschied', 'melancholie'],
                'wut': ['wut', 'ärger', 'frustration', 'enttäuschung'],
                'hoffnung': ['hoffnung', 'optimismus', 'zuversicht', 'erwartung']
            };
            
            const userMessageLower = userMessage.toLowerCase();
            
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                if (keywords.some(keyword => userMessageLower.includes(keyword))) {
                    sessionData.emotions.push({
                        emotion: emotion,
                        timestamp: new Date(),
                        phase: currentPhase,
                        context: userMessage.substring(0, 100) + '...'
                    });
                    break;
                }
            }
            
            // Extract goals/wishes from user message
            const goalKeywords = ['möchte', 'will', 'wünsche', 'ziel', 'traum', 'vision', 'plane'];
            if (goalKeywords.some(keyword => userMessageLower.includes(keyword))) {
                sessionData.goals.push({
                    goal: userMessage,
                    timestamp: new Date(),
                    phase: currentPhase
                });
            }
        }
        
        function progressToNextPhase() {
            if (currentPhase < 8) {
                currentPhase++;
                updatePhaseDisplay();
                
                // Send phase transition message
                setTimeout(() => {
                    const transitionMessage = getPhaseTransitionMessage();
                    addMessage(transitionMessage, 'ai');
                }, 1500);
            }
        }
        
        function getPhaseTransitionMessage() {
            const phase = phaseConfig[currentPhase];
            return `🎯 <strong>Wunderbar! Lass uns zur nächsten Phase übergehen.</strong><br><br>
                    <strong>Phase ${currentPhase}: ${phase.name}</strong><br><br>
                    ${phase.description} Ich bin gespannt auf deine Gedanken dazu!`;
        }
        
        // UI Management Functions
        function updatePhaseDisplay() {
            const phase = phaseConfig[currentPhase];
            document.getElementById('phaseName').textContent = `Phase ${currentPhase}: ${phase.name}`;
            document.getElementById('phaseDescription').textContent = phase.description;
            
            const progressPercentage = (currentPhase / 8) * 100;
            document.getElementById('phaseProgress').style.width = `${progressPercentage}%`;
        }
        
        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'flex';
            document.getElementById('sendBtn').disabled = true;
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
            document.getElementById('sendBtn').disabled = false;
        }
        
        // Message Handling
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || message.length > 500) return;
            
            // Add user message
            addMessage(message, 'user');
            input.value = '';
            autoResize(input);
            updateCharCounter();
            
            // Store in session data
            sessionData.messages.push({
                sender: 'user',
                message: message,
                timestamp: new Date(),
                phase: currentPhase
            });
            
            // Generate AI response
            try {
                const aiResponse = await generateAIResponse(message);
                addMessage(aiResponse, 'ai');
                
                // Store AI response with metadata
                sessionData.messages.push({
                    sender: 'ai',
                    message: aiResponse,
                    timestamp: new Date(),
                    phase: currentPhase,
                    responseLength: aiResponse.length,
                    processingTime: Date.now() - Date.now() // Will be updated in real implementation
                });
                
            } catch (error) {
                console.error('Error generating response:', error);
                addMessage('Entschuldigung, es gab einen technischen Fehler. Bitte versuche es erneut.', 'ai error-message');
            }
        }
        
        function addMessage(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            if (type === 'user' || type === 'ai') {
                messageCount++;
                document.getElementById('messageCount').textContent = messageCount;
            }
        }
        
        // Input Handling
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            const hasText = textarea.value.trim().length > 0 && textarea.value.length <= 500;
            document.getElementById('sendBtn').disabled = !hasText;
        }
        
        function updateCharCounter() {
            const input = document.getElementById('chatInput');
            const counter = document.getElementById('charCounter');
            const length = input.value.length;
            counter.textContent = `${length}/500`;
            
            if (length > 450) {
                counter.style.color = '#dc2626';
            } else if (length > 350) {
                counter.style.color = '#f59e0b';
            } else {
                counter.style.color = '#9ca3af';
            }
        }
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Session Timer
        function updateSessionTimer() {
            const now = new Date();
            const elapsed = Math.floor((now - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sessionTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Start session timer
            setInterval(updateSessionTimer, 1000);
            
            // Focus input
            document.getElementById('chatInput').focus();
            
            // Initialize displays
            updatePhaseDisplay();
            updateCharCounter();
        });
    </script>
</body>
</html>