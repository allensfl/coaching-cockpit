<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Chat Interface - KI-Online.Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .slots-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .slot {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 3px solid #FFD700;
        }

        .slot-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .slot-value {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .phases-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .phase-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .phase-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .phase-btn.active {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            font-weight: 600;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 20px;
        }

        .chat-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            text-align: center;
            color: #FFD700;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.COACH {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            margin-left: 0;
            margin-right: auto;
        }

        .message.KI {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            margin-left: auto;
            margin-right: 0;
        }

        .message.COACHEE {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            margin-left: auto;
            margin-right: 0;
        }

        .message.SYSTEM {
            background: rgba(255, 255, 255, 0.2);
            text-align: center;
            margin: 10px auto;
            font-style: italic;
            opacity: 0.8;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        .input-area {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .coach-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            color: #333;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .coach-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #FFD700;
        }

        .send-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .waiting-message {
            text-align: center;
            opacity: 0.7;
            font-style: italic;
            padding: 40px 20px;
            color: #FFD700;
        }

        /* PHASE INSTRUCTIONS STYLING */
        .phase-instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .phase-instructions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .phase-instructions-header h3 {
            color: #FFD700;
            margin: 0;
            font-size: 1.1rem;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .instructions-content {
            padding: 20px;
        }

        .coach-actions h4 {
            color: #4CAF50;
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .coach-actions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .coach-actions li {
            background: rgba(255, 255, 255, 0.05);
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .ki-prompt-suggestion {
            margin-top: 20px;
        }

        .ki-prompt-suggestion h4 {
            color: #FFD700;
            margin: 0 0 10px 0;
            font-size: 1rem;
        }

        .prompt-box {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .prompt-box code {
            flex: 1;
            color: #FFD700;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
            display: block;
        }

        .use-prompt-btn {
            background: #FFD700;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            transition: background 0.3s ease;
        }

        .use-prompt-btn:hover {
            background: #FFA500;
        }

        @media (max-width: 768px) {
            .slots-container {
                grid-template-columns: 1fr;
            }
            
            .phases-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }

            .prompt-box {
                flex-direction: column;
                align-items: stretch;
            }

            .use-prompt-btn {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 Coach Chat Interface</h1>
        <p>Aktive Coaching-Session mit KI-Unterstützung</p>
    </div>

    <div class="slots-container">
        <div class="slot">
            <div class="slot-label">Klient:</div>
            <div class="slot-value" id="slot-klient">--</div>
        </div>
        <div class="slot">
            <div class="slot-label">Phase:</div>
            <div class="slot-value" id="slot-phase">Standortbestimmung</div>
        </div>
        <div class="slot">
            <div class="slot-label">Session Thema:</div>
            <div class="slot-value" id="slot-thema">--</div>
        </div>
        <div class="slot">
            <div class="slot-label">Aktuelle Rolle:</div>
            <div class="slot-value" id="slot-rolle">--</div>
        </div>
    </div>

    <div class="phases-container">
        <button class="phase-btn active" data-phase="1">1. Standort</button>
        <button class="phase-btn" data-phase="2">2. Emotion</button>
        <button class="phase-btn" data-phase="3">3. Vision</button>
        <button class="phase-btn" data-phase="4">4. System</button>
        <button class="phase-btn" data-phase="5">5. Balance</button>
        <button class="phase-btn" data-phase="6">6. Erfolg</button>
        <button class="phase-btn" data-phase="7">7. Schritte</button>
        <button class="phase-btn" data-phase="8">8. Integration</button>
    </div>

    <div class="main-container">
        <!-- PHASE INSTRUCTIONS BOX -->
        <div class="phase-instructions" id="phase-instructions">
            <div class="phase-instructions-header">
                <h3>Phase 1: Standortbestimmung</h3>
                <button class="toggle-btn" onclick="toggleInstructions()">▼</button>
            </div>
            <div class="instructions-content" id="instructions-content">
                <div class="coach-actions">
                    <h4>Coach-Aktionen:</h4>
                    <ul id="instructions-list">
                        <li>Coach begrüßt Coachingpartner und stellt das KI-Coaching-Konzept vor</li>
                        <li>Coach regt Coachee an, IST- und SOLL-Situation zu beschreiben</li>
                    </ul>
                </div>
                <div class="ki-prompt-suggestion">
                    <h4>Vorgeschlagener KI-Prompt:</h4>
                    <div class="prompt-box">
                        <code id="suggested-prompt">&lt;KI&gt; Erstelle einen strukturierten Bericht der Coachingproblematik mit IST- und SOLL-Situation.</code>
                        <button onclick="useSuggestedPrompt()" class="use-prompt-btn">📋 Verwenden</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                Coaching-Session bereit
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="waiting-message">
                    Warten auf Klient-Messages...<br>
                    KI-System ist aktiviert und bereit.
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="coachInput" 
                    class="coach-input" 
                    placeholder="Coach-Nachricht oder KI-Anweisung eingeben..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">Senden</button>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="updateSlot()">🔧 Slot Update</button>
                <button class="action-btn" onclick="showAllSlots()">📋 Alle Slots anzeigen</button>
                <button class="action-btn" onclick="generateKIInstruction()">🤖 KI Anweisung</button>
                <button class="action-btn" onclick="nextPhase()">➡️ Nächste Phase</button>
                <button class="action-btn" onclick="sendCoachMessageToKlient()">👥 An Klient</button>
            </div>
        </div>
    </div>

   <script>
// Globale Variable für aktuelle Klient Session
let currentKlientSessionId = null;

// Read session ID from URL
const urlParams = new URLSearchParams(window.location.search);
const sessionFromUrl = urlParams.get('session');
if (sessionFromUrl) {
    currentKlientSessionId = sessionFromUrl;
    console.log('🔗 Session ID from URL:', currentKlientSessionId);
}

// Global state mit Thread-Management (NACH der Session-ID Definition)
let currentSession = {
    id: currentKlientSessionId || generateId(),
    threadId: null,
    slots: {
        klient_name: "",
        aktuelle_rolle: "",
        wunsch_rolle: "",
        wert_1: "",
        wert_2: "",
        session_thema: "",
        phase: "Standortbestimmung"
    },
    messages: [],
    currentPhase: 1
};

        let editingMessage = null;

        // Phase Definitions mit Coach-Anweisungen
        const phases = {
            1: { 
                name: "Standortbestimmung", 
                prompt: "Erzähle mir, was dich am meisten bewegt und was dein Herzenswunsch ist.",
                instructions: [
                    "Coach begrüßt Coachingpartner und stellt das KI-Coaching-Konzept vor",
                    "Coach regt Coachee an, IST- und SOLL-Situation zu beschreiben", 
                    "Coach fasst Schlüsselsituation und Schlüsselaffekt zusammen"
                ],
                kiPrompt: "Erstelle einen strukturierten Bericht der Coachingproblematik mit IST- und SOLL-Situation. Rekonstruiere den Teufelskreislauf."
            },
            2: { 
                name: "Emotionale Vertiefung", 
                prompt: "Welches Bild, welche Farbe oder Metapher spiegelt dein zentrales Gefühl?",
                instructions: [
                    "Coach lässt KI-Antwort auf Coachee wirken",
                    "Coach zeigt Fotos zur Visualisierung des Schlüsselaffekts",
                    "Coach führt immersive Bildbetrachtung durch"
                ],
                kiPrompt: "Analysiere die Bedeutung des gewählten Bildes für die Coachingproblematik. Erkunde den Schlüsselaffekt."
            },
            3: { 
                name: "Zielvision", 
                prompt: "Stelle dir deinen erfüllten Ruhestand vor – welches Symbol steht dafür?",
                instructions: [
                    "Coach bietet Fotos für Ziel-Visualisierung an",
                    "Coach führt immersive Betrachtung des Ziel-Bildes durch",
                    "Coach verankert Zielvision sinnlich und emotional"
                ],
                kiPrompt: "Entwickle eine kraftvolle, sinnlich verankerte Vision für den erfüllten Ruhestand basierend auf dem Ziel-Bild."
            },
            4: { 
                name: "Systemanalyse", 
                prompt: "Welche Stimmen in dir stehen im Widerstreit?",
                instructions: [
                    "Coach erklärt das Konzept des Inneren Teams",
                    "Coach führt psychodramatisches Tiefeninterview durch",
                    "Coach identifiziert unterstützende und hindernde Persönlichkeitsanteile"
                ],
                kiPrompt: "Rekonstruiere den Teufelskreislauf basierend auf dem Tiefeninterview. Erkenne den heimlichen Wunsch."
            },
            5: { 
                name: "Komplementärkräfte", 
                prompt: "Wo fehlt dir Balance zwischen Aktion und Reflexion?",
                instructions: [
                    "Coach erklärt Ausbalancierungsprobleme und Komplementärkräfte",
                    "Coach identifiziert dominante Problemlösungsorientierungen", 
                    "Coach entwickelt ausgleichende Gegenkräfte"
                ],
                kiPrompt: "Analysiere die Ausbalancierungsprobleme. Identifiziere die nötigen Komplementärkräfte zur besseren Balance."
            },
            6: { 
                name: "Erfolgsimagination", 
                prompt: "Beschreibe zwei verschiedene Szenarien deines erfolgreichen Ruhestands.",
                instructions: [
                    "Coach leitet detaillierte Erfolgsimagination an",
                    "Coach achtet auf filmreife, lebensnah Beschreibung",
                    "Coach lässt zwei Erfolgsszenarien entwickeln und eins auswählen"
                ],
                kiPrompt: "Erstelle zwei filmreife Erfolgsimaginationen basierend auf gestärkten Komplementärkräften."
            },
            7: { 
                name: "Konkrete Schritte", 
                prompt: "Welche drei Aktivitäten unterstützen dein Ziel?",
                instructions: [
                    "Coach hilft bei Auswahl der bevorzugten Erfolgsimagination",
                    "Coach leitet Planung von drei Problemlösungsaktivitäten an",
                    "Coach protokolliert Sofort-Aktion, Wochenaufgabe und Experiment"
                ],
                kiPrompt: "Schlage drei konkrete Problemlösungshandlungen vor: Sofort-Aktion, Wochenaufgabe und Experiment."
            },
            8: { 
                name: "Integration", 
                prompt: "Was nimmst du aus dieser Sitzung mit?",
                instructions: [
                    "Coach fragt nach Umsetzungserfahrungen",
                    "Coach fokussiert auf Erfolge und Misserfolge",
                    "Coach reflektiert gemeinsam und plant nächste Schritte"
                ],
                kiPrompt: "Analysiere Erfolgs- und Misserfolgserlebnisse. Entwickle Learnings für die Zukunft."
            }
        };

        // Utility Functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        // Message Functions
        function addMessage(type, content, approved = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            // Remove waiting message if present
            const waitingMessage = messagesContainer.querySelector('.waiting-message');
            if (waitingMessage) {
                waitingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                ${content}
                <div class="message-time">${getCurrentTime()}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const message = {
                id: generateId(),
                type: type,
                content: content,
                timestamp: getCurrentTime(),
                approved: approved
            };

            currentSession.messages.push(message);
            console.log('💬 Message added:', { type, content: content.substring(0, 50), approved });
            
            return messageDiv;
        }

        // AI Integration
        async function callRuhestandSynthAPI(message, context = '') {
            try {
                console.log('🤖 Calling RuhestandSynth API...');
                const requestData = {
                    message: message,
                    sessionContext: context,
                    currentPhase: currentSession.currentPhase,
                    slots: currentSession.slots,
                    threadId: currentSession.threadId,
                    messageHistory: currentSession.messages.filter(m => m.approved).slice(-5)
                };

                const response = await fetch('/api/ruhestand-coach', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                console.log('✅ RuhestandSynth response:', data);

                if (data.threadId && !currentSession.threadId) {
                    currentSession.threadId = data.threadId;
                    console.log('💾 Thread ID saved:', data.threadId);
                }

                return data;
            } catch (error) {
                console.error('❌ API call failed:', error);
                return {
                    success: false,
                    response: getFallbackResponse(),
                    error: error.message
                };
            }
        }

        function getFallbackResponse() {
            const fallbacks = {
                1: "«Ich höre, dass dich etwas Wichtiges beschäftigt. Magst du mir mehr darüber erzählen?»",
                2: "«Welches Gefühl ist gerade am stärksten in dir?»",
                3: "«Wie stellst du dir deinen idealen Ruhestand vor?»",
                4: "«Welche inneren Stimmen hörst du?»",
                5: "«Wo brauchst du mehr Balance?»",
                6: "«Beschreibe deinen erfolgreichen Ruhestand.»",
                7: "«Welche konkreten Schritte könntest du gehen?»",
                8: "«Was nimmst du aus unserem Gespräch mit?»"
            };
            return fallbacks[currentSession.currentPhase] || "«Erzähle mir mehr – ich bin hier, um dich zu begleiten.»";
        }

        // Message an Klient senden
        async function sendMessageToKlient(author, content) {
            if (!currentKlientSessionId) {
                console.error('❌ No klient session ID available');
                alert('Noch keine Klient-Session aktiv. Warten Sie auf eine Klient-Message.');
                return false;
            }
            
            try {
                console.log(`📤 Sending ${author} message to klient session: ${currentKlientSessionId}`);
                
                const response = await fetch('/api/send-to-klient-new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentKlientSessionId,
                        author: author,
                        content: content,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Message sent to klient session:', currentKlientSessionId);
                    console.log('📋 Send result:', result);
                    return true;
                } else {
                    console.error('❌ Failed to send message to klient:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('❌ Error sending message to klient:', error);
                return false;
            }
        }

        // KI Response für Klient
        async function generateKIResponseForKlient(userMessage) {
            console.log('🤖 Generating AI response for coach review...');
            
            try {
                const apiResult = await callRuhestandSynthAPI(userMessage);
                console.log('🎯 AI API result:', apiResult);
                
                if (apiResult.success) {
                    console.log('✅ AI response generated:', apiResult.response.substring(0, 100));
                    
                    const aiMessage = addMessage('KI', `AI-Vorschlag: ${apiResult.response}`, false);
                    aiMessage.dataset.aiResponse = apiResult.response;
                    
                    const approveButton = document.createElement('button');
                    approveButton.textContent = '✅ An Klient freigeben';
                    approveButton.style.cssText = 'margin-top: 8px; padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;';
                    approveButton.onclick = () => approveAIResponse(aiMessage, apiResult.response);
                    aiMessage.appendChild(approveButton);
                    
                    console.log('🔍 AI response ready for coach approval');
                    
                    if (apiResult.extractedSlots) {
                        Object.entries(apiResult.extractedSlots).forEach(([key, value]) => {
                            updateSlotValue(key, value);
                        });
                    }
                    
                } else {
                    console.error('❌ AI response failed:', apiResult.error);
                    const fallback = getFallbackResponse();
                    addMessage('KI', `AI-Vorschlag (Fallback): ${fallback}`, false);
                }
            } catch (error) {
                console.error('❌ Error generating AI response:', error);
            }
        }

        async function approveAIResponse(messageElement, aiResponse) {
            console.log('📤 Coach approves AI response for klient...');
            
            const sent = await sendMessageToKlient('ki', aiResponse);
            
            if (sent) {
                console.log('✅ AI response delivered to klient after approval');
                messageElement.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
                messageElement.innerHTML = `Freigegeben an Klient: ${aiResponse}<div class="message-time">${getCurrentTime()}</div>`;
                
                addMessage('SYSTEM', '✅ AI-Antwort an Klient gesendet', false);
            } else {
                console.log('❌ Failed to deliver approved AI response');
                addMessage('SYSTEM', '❌ Fehler beim Senden an Klient', false);
            }
        }

        // Klient Message Polling
        async function pollKlientMessages() {
            console.log('🔄 Polling for klient messages...');
            
            try {
                const response = await fetch(`/api/klient-message?type=coach_poll&sessionId=${currentSession.id}&t=${Date.now()}`);
                console.log('📡 Polling response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📊 Polling data received:', data);
                    
                    if (data.messages && data.messages.length > 0) {
                        console.log(`🎉 Found ${data.messages.length} new klient messages!`);
                        
                        data.messages.forEach(msg => {
                            console.log('📨 Processing klient message:', msg);
                            
                            if (msg.sessionId && msg.sessionId !== currentKlientSessionId) {
                                currentKlientSessionId = msg.sessionId;
                                console.log('💾 Updated current klient session ID:', currentKlientSessionId);
                                updateSlotValue('klient_name', 'Aktiver Klient');
                            }
                            
                            addMessage('COACHEE', msg.content, true);
                            console.log('✅ Message added to coach interface');
                            
                            setTimeout(() => {
                                console.log('🤖 Auto-generating AI response for:', msg.content.substring(0, 50));
                                generateKIResponseForKlient(msg.content);
                            }, 1000);
                        });
                    } else {
                        console.log('📭 No new messages');
                    }
                } else {
                    console.error('❌ Polling failed:', response.status);
                }
            } catch (error) {
                console.error('❌ Error polling klient messages:', error);
            }
        }

        function sendCoachMessageToKlient() {
            const message = document.getElementById('coachInput').value.trim();
            if (!message) {
                alert('Bitte geben Sie eine Nachricht ein.');
                return;
            }
            
            if (!currentKlientSessionId) {
                alert('Noch keine Klient-Session aktiv. Warten Sie auf eine Klient-Message.');
                return;
            }
            
            sendMessageToKlient('coach', message).then(success => {
                if (success) {
                    addMessage('COACH', `An Klient gesendet: ${message}`, true);
                    document.getElementById('coachInput').value = '';
                } else {
                    alert('Fehler beim Senden der Nachricht.');
                }
            });
        }

        function sendCoachMessage() {
            const input = document.getElementById('coachInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            if (content.startsWith('<KI>') || content.includes('setze ')) {
                addMessage('KI', content, false);
                
                if (content.includes('setze ')) {
                    extractSlotsFromInstruction(content);
                }
                
                setTimeout(() => {
                    console.log('🤖 Generating AI response for coach instruction:', content.substring(0, 50));
                    generateKIResponseForKlient(content);
                }, 1000);
                
            } else {
                addMessage('COACH', content, true);
            }
            
            input.value = '';
        }

        function extractSlotsFromInstruction(instruction) {
            const slotMatches = instruction.match(/setze (\w+)=["']?([^"']+)["']?/g);
            if (slotMatches) {
                slotMatches.forEach(match => {
                    const [, key, value] = match.match(/setze (\w+)=["']?([^"']+)["']?/);
                    updateSlotValue(key, value);
                });
            }
        }

        function showAllSlots() {
            const slots = currentSession.slots;
            let slotDisplay = "📋 ALLE SESSION-SLOTS:\n\n";
            
            Object.entries(slots).forEach(([key, value]) => {
                slotDisplay += `${key}: "${value || '--'}"\n`;
            });
            
            slotDisplay += `\nKlient Session ID: ${currentKlientSessionId || 'Keine aktive Session'}`;
            slotDisplay += `\nThread ID: ${currentSession.threadId || 'Nicht gesetzt'}`;
            slotDisplay += `\nPhase: ${currentSession.currentPhase}/8`;
            
            alert(slotDisplay);
        }

        function updateSlotValue(key, value) {
            currentSession.slots[key] = value;
            updateSlotDisplay();
            saveSessionState();
        }

        function updateSlotDisplay() {
            const slots = currentSession.slots;
            const klientElement = document.getElementById('slot-klient');
            const phaseElement = document.getElementById('slot-phase');
            const themaElement = document.getElementById('slot-thema');
            const rolleElement = document.getElementById('slot-rolle');

            if (klientElement) klientElement.textContent = slots.klient_name || '--';
            if (phaseElement) phaseElement.textContent = slots.phase || 'Standortbestimmung';
            if (themaElement) themaElement.textContent = slots.session_thema || '--';
            if (rolleElement) rolleElement.textContent = slots.aktuelle_rolle || '--';
        }

        function updateSlot() {
            const key = prompt('Slot Name (z.B. klient_name, session_thema):');
            const value = prompt('Slot Wert:');
            if (key && value) {
                updateSlotValue(key, value);
            }
        }

        function nextPhase() {
            if (currentSession.currentPhase < 8) {
                currentSession.currentPhase++;
                const phaseName = phases[currentSession.currentPhase].name;
                updateSlotValue('phase', phaseName);
                updatePhaseDisplay();
            }
        }

        function updatePhaseDisplay() {
            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-phase="${currentSession.currentPhase}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Update phase instructions
            updatePhaseInstructions();
        }

        // Update Phase Instructions
        function updatePhaseInstructions() {
            const phase = phases[currentSession.currentPhase];
            if (!phase) return;
            
            // Update title
            const header = document.querySelector('.phase-instructions-header h3');
            if (header) {
                header.textContent = `Phase ${currentSession.currentPhase}: ${phase.name}`;
            }
            
            // Update instructions list
            const instructionsList = document.getElementById('instructions-list');
            if (instructionsList && phase.instructions) {
                instructionsList.innerHTML = phase.instructions.map(instruction => 
                    `<li>${instruction}</li>`
                ).join('');
            }
            
            // Update suggested prompt
            const suggestedPrompt = document.getElementById('suggested-prompt');
            if (suggestedPrompt && phase.kiPrompt) {
                suggestedPrompt.textContent = `<KI> ${phase.kiPrompt}`;
            }
        }

        // Global functions for onclick handlers
        window.toggleInstructions = function() {
            const content = document.getElementById('instructions-content');
            const toggle = document.querySelector('.toggle-btn');
            
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '▼';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '▶';
                }
            }
        };

        window.useSuggestedPrompt = function() {
            const phase = phases[currentSession.currentPhase];
            if (phase && phase.kiPrompt) {
                const input = document.getElementById('coachInput');
                if (input) {
                    input.value = `<KI> ${phase.kiPrompt}`;
                    input.focus();
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                }
            }
        };

        function generateKIInstruction() {
            const currentPhaseData = phases[currentSession.currentPhase];
            const instruction = `<KI> Phase ${currentSession.currentPhase}: ${currentPhaseData.prompt}`;
            
            document.getElementById('coachInput').value = instruction;
            addMessage('SYSTEM', `KI-Anweisung für Phase ${currentSession.currentPhase} generiert`, false);
        }

        function saveSessionState() {
            const sessionData = {
                id: currentSession.id,
                threadId: currentSession.threadId,
                slots: currentSession.slots,
                currentPhase: currentSession.currentPhase,
                messageCount: currentSession.messages.length,
                lastActivity: new Date().toISOString(),
                klientSessionId: currentKlientSessionId
            };
            localStorage.setItem('coachingSession', JSON.stringify(sessionData));
            console.log('💾 Session state saved:', sessionData);
        }

        function loadSessionState() {
            const savedSession = localStorage.getItem('coachingSession');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    const lastActivity = new Date(sessionData.lastActivity);
                    const now = new Date();
                    const hoursDiff = (now - lastActivity) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 24) {
                        currentSession.threadId = sessionData.threadId;
                        currentSession.slots = sessionData.slots || currentSession.slots;
                        currentSession.currentPhase = sessionData.currentPhase || 1;
                        currentKlientSessionId = sessionData.klientSessionId;
                        
                        console.log('📥 Session state loaded:', {
                            threadId: sessionData.threadId,
                            phase: sessionData.currentPhase,
                            klientSessionId: currentKlientSessionId,
                            hoursOld: Math.round(hoursDiff)
                        });
                        
                        updateSlotDisplay();
                        updatePhaseDisplay();
                        return true;
                    } else {
                        console.log('🗑️ Session too old, starting fresh');
                        localStorage.removeItem('coachingSession');
                    }
                } catch (e) {
                    console.error('❌ Error loading session:', e);
                }
            }
            return false;
        }

        function setupEventListeners() {
            const sendButton = document.getElementById('sendButton');
            const coachInput = document.getElementById('coachInput');

            sendButton.addEventListener('click', sendCoachMessage);

            coachInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendCoachMessage();
                } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    sendCoachMessage();
                }
            });

            coachInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            document.querySelectorAll('.phase-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const phase = parseInt(this.dataset.phase);
                    currentSession.currentPhase = phase;
                    updateSlotValue('phase', phases[phase].name);
                    updatePhaseDisplay();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Coach Chat Interface initialized');
            console.log('Session ID:', currentSession.id);
            
            const sessionLoaded = loadSessionState();
            if (!sessionLoaded) {
                updateSlotDisplay();
            }

            // Initialize phase instructions
            updatePhaseInstructions();

            setupEventListeners();

            setInterval(pollKlientMessages, 2000);
            setTimeout(pollKlientMessages, 1000);

            window.addEventListener('beforeunload', saveSessionState);
            setInterval(saveSessionState, 30000);

            console.log('🌉 Coach-Klient Bridge initialized');
        });
    </script>
</body>
</html>