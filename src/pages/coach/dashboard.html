<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Dashboard - KI-Online.Coach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Trial Banner Styles */
        .banner {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid;
        }

        .banner.trial {
            border-left-color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
        }

        .banner.active {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .banner.urgent {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .banner-text {
            font-size: 16px;
            font-weight: 500;
        }

        .banner-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .banner-button:hover {
            transform: translateY(-2px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.8;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .client-section {
            margin-top: 50px;
        }

        .add-client-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: transform 0.2s ease;
        }

        .add-client-btn:hover {
            transform: translateY(-2px);
        }

        .client-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .client-card:hover {
            transform: translateY(-3px);
        }

        .client-card h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }

        .client-card p {
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .tools-section {
            margin-top: 50px;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .tool-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .tool-card:hover {
            transform: translateY(-5px);
        }

        .tool-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .tool-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #FFD700;
        }

        .tool-description {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="dashboard-container">
        <!-- Dynamic Banner -->
        <div id="statusBanner" class="banner trial">
            <div class="banner-text">
                <span id="bannerText">üîÑ Trial-Status wird geladen...</span>
            </div>
            <button class="banner-button" id="trialButton" onclick="openTrialModal()">Trial Status</button>
        </div>

        <!-- Header -->
        <div class="header">
            <h1 id="dashboardTitle">Coach Dashboard</h1>
            <p id="welcomeMessage">Willkommen in Ihrem KI-gest√ºtzten Coaching Cockpit</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="clientCount">0</div>
                <div class="stat-label">Aktive Klienten</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="sessionCount">0</div>
                <div class="stat-label">Coaching Sessions</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="satisfactionRate">--</div>
                <div class="stat-label">Zufriedenheitsrate</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="timeSaved">--</div>
                <div class="stat-label">Gesparte Zeit</div>
            </div>
        </div>

        <!-- Coaching Tools -->
        <div class="tools-section">
            <h2 class="section-title">Coaching Tools</h2>
            <div class="tools-grid">
                <div class="tool-card" onclick="openKIChat()">
                    <div class="tool-icon">ü§ñ</div>
                    <div class="tool-title">KI-Chat System</div>
                    <div class="tool-description">8-Phasen Ruhestandscoaching mit KI-Unterst√ºtzung</div>
                </div>
                <div class="tool-card" onclick="openAnalytics()" data-trial-feature="advanced_analytics">
                    <div class="tool-icon">üìä</div>
                    <div class="tool-title">Analytics</div>
                    <div class="tool-description">Detaillierte Fortschrittsdaten Ihrer Klienten</div>
                </div>
                <div class="tool-card" onclick="openSessionNotes()">
                    <div class="tool-icon">üìù</div>
                    <div class="tool-title">Session Notes</div>
                    <div class="tool-description">Digitale Notizen und Dokumentation</div>
                </div>
                <div class="tool-card" onclick="openCalendar()" data-trial-feature="calendar_integration">
                    <div class="tool-icon">üìÖ</div>
                    <div class="tool-title">Terminplanung</div>
                    <div class="tool-description">Intelligente Kalender-Integration</div>
                </div>
            </div>
        </div>

        <!-- Client Management Section -->
        <div class="client-section">
            <h2 class="section-title">Klienten-Management</h2>
            <button class="add-client-btn" onclick="inviteClient()">
                + Neuen Klienten einladen
            </button>
            
            <div class="client-grid" id="clientGrid">
                <!-- Clients will be loaded dynamically -->
                <div class="client-card">
                    <h3>Demo Klient</h3>
                    <p><strong>Coaching-Typ:</strong> Ruhestandsplanung</p>
                    <p><strong>Letzte Session:</strong> Noch keine</p>
                    <p><strong>Fortschritt:</strong> Phase 1/8</p>
                    <p><strong>Status:</strong> <span style="color: #4CAF50;">Bereit</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Trial Manager -->
    <script src="trial-manager.js"></script>
    
    <!-- Dashboard Logic -->
    <script>
        // Global state
        let currentCoach = null;
        let trialData = null;
        let dashboardInitialized = false;

        console.log('üéØ Dashboard script loading...');

        // Get coach data from multiple sources
        function getCoachDataFromSources() {
            console.log('üîç Getting coach data from all sources...');
            
            // 1. URL Parameters (highest priority)
            const urlParams = new URLSearchParams(window.location.search);
            const coachId = urlParams.get('coachId');
            const email = urlParams.get('email');
            const firstName = urlParams.get('firstName');
            
            if (coachId && email) {
                console.log('‚úÖ Found coach data in URL:', { coachId, email, firstName });
                return {
                    id: coachId,
                    email: email,
                    firstName: firstName || 'Coach',
                    lastName: urlParams.get('lastName') || '',
                    source: 'url'
                };
            }
            
            // 2. Session Storage
            const sessionData = sessionStorage.getItem('coachData');
            if (sessionData) {
                try {
                    const parsed = JSON.parse(sessionData);
                    if (parsed.coachId || parsed.id) {
                        console.log('‚úÖ Found coach data in sessionStorage:', parsed);
                        return {
                            id: parsed.coachId || parsed.id,
                            email: parsed.email,
                            firstName: parsed.firstName,
                            lastName: parsed.lastName,
                            source: 'session'
                        };
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error parsing sessionStorage:', e);
                }
            }
            
            // 3. Local Storage
            const localData = localStorage.getItem('currentCoach');
            if (localData) {
                try {
                    const parsed = JSON.parse(localData);
                    if (parsed.id && parsed.id !== '0db62df4-8471-46b9-a47c-37c86bfb61cd') {
                        console.log('‚úÖ Found coach data in localStorage:', parsed);
                        return {
                            id: parsed.id,
                            email: parsed.email,
                            firstName: parsed.firstName,
                            lastName: parsed.lastName,
                            source: 'local'
                        };
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error parsing localStorage:', e);
                }
            }
            
            console.log('‚ùå No valid coach data found');
            return null;
        }

        // Store coach data in all storage locations
        function storeCoachData(coachData) {
            console.log('üíæ Storing coach data:', coachData);
            
            // Store in localStorage for persistence
            localStorage.setItem('currentCoach', JSON.stringify(coachData));
            localStorage.setItem('coachId', coachData.id);
            localStorage.setItem('coachEmail', coachData.email);
            
            // Store in sessionStorage for current session
            sessionStorage.setItem('coachData', JSON.stringify(coachData));
            
            currentCoach = coachData;
        }

        // Load real trial data
        async function loadTrialData(coachId) {
            console.log('üîç Loading trial data for coach:', coachId);
            
            try {
                const response = await fetch(`/api/trial-management?coachId=${coachId}`);
                
                if (!response.ok) {
                    console.error('‚ùå Trial API response not ok:', response.status);
                    return null;
                }
                
                const data = await response.json();
                console.log('üìä Trial API response:', data);
                
                if (data.success && data.trial) {
                    trialData = data.trial;
                    console.log('‚úÖ Trial data loaded successfully:', {
                        status: trialData.status,
                        daysLeft: trialData.days_left,
                        email: trialData.email
                    });
                    
                    // Update coach data with trial info
                    if (currentCoach) {
                        currentCoach.trialDaysLeft = trialData.days_left;
                        currentCoach.trialStatus = trialData.status;
                        currentCoach.trialEnd = trialData.trial_end;
                        
                        // Update name if available from trial data
                        if (trialData.coach_data) {
                            currentCoach.firstName = trialData.coach_data.firstName || currentCoach.firstName;
                            currentCoach.lastName = trialData.coach_data.lastName || currentCoach.lastName;
                        }
                        
                        storeCoachData(currentCoach);
                    }
                    
                    return trialData;
                }
                
                console.warn('‚ö†Ô∏è Trial API returned no data');
                return null;
                
            } catch (error) {
                console.error('‚ùå Error loading trial data:', error);
                return null;
            }
        }

        // Update banner with trial info
        function updateTrialBanner() {
            const banner = document.getElementById('statusBanner');
            const bannerText = document.getElementById('bannerText');
            const button = document.getElementById('trialButton');
            
            if (!trialData || !currentCoach) {
                bannerText.textContent = 'üîÑ Trial-Status wird geladen...';
                return;
            }
            
            const status = trialData.status || 'active';
            const daysLeft = trialData.days_left || 0;
            
            // Remove existing classes
            banner.className = 'banner';
            
            if (status === 'paid') {
                banner.classList.add('active');
                bannerText.innerHTML = '‚úÖ Premium Account aktiv ‚Ä¢ Alle Features verf√ºgbar';
                button.textContent = 'Account Status';
            } else if (status === 'active') {
                if (daysLeft <= 3) {
                    banner.classList.add('urgent');
                } else {
                    banner.classList.add('trial');
                }
                bannerText.innerHTML = `üïê Noch ${daysLeft} Tage Trial ‚Ä¢ Testen Sie alle Features kostenlos`;
                button.textContent = 'Jetzt upgraden';
            } else {
                banner.classList.add('urgent');
                bannerText.innerHTML = '‚ùå Trial abgelaufen ‚Ä¢ Upgrade erforderlich';
                button.textContent = 'Jetzt upgraden';
            }
            
            console.log('üé® Banner updated:', { status, daysLeft });
        }

        // Update dashboard content
        function updateDashboardContent() {
            if (!currentCoach) return;
            
            // Update header
            const title = document.getElementById('dashboardTitle');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            if (currentCoach.firstName) {
                title.textContent = `Coach Dashboard - ${currentCoach.firstName}`;
                welcomeMessage.textContent = `Willkommen zur√ºck, ${currentCoach.firstName}!`;
            }
            
            // Update stats based on trial status
            if (trialData && trialData.status === 'active') {
                // Trial user - show starter values
                document.getElementById('clientCount').textContent = '0';
                document.getElementById('sessionCount').textContent = '0';
                document.getElementById('satisfactionRate').textContent = '95%';
                document.getElementById('timeSaved').textContent = '0h';
            } else {
                // Paid user - could show real stats
                document.getElementById('clientCount').textContent = '5';
                document.getElementById('sessionCount').textContent = '24';
                document.getElementById('satisfactionRate').textContent = '89%';
                document.getElementById('timeSaved').textContent = '12h';
            }
            
            console.log('üìä Dashboard content updated');
        }

        // Trial modal functions
        function openTrialModal() {
            if (window.trialManager && typeof window.trialManager.showTrialModal === 'function') {
                console.log('üéØ Opening trial modal via trial manager');
                window.trialManager.showTrialModal();
            } else {
                console.log('üéØ Trial manager not available, showing simple modal');
                showSimpleTrialModal();
            }
        }

        function showSimpleTrialModal() {
            if (!trialData) {
                alert('Trial-Daten werden noch geladen...');
                return;
            }
            
            const status = trialData.status;
            const daysLeft = trialData.days_left || 0;
            
            if (status === 'paid') {
                alert('‚úÖ Premium Account aktiv!\n\nSie haben Zugang zu allen Features.');
            } else if (status === 'active') {
                alert(`‚è∞ Trial aktiv!\n\nNoch ${daysLeft} Tage verbleibend.\n\nUpgrade f√ºr volle Features!`);
            } else {
                alert('‚ùå Trial abgelaufen!\n\nUpgrade erforderlich f√ºr weiteren Zugang.');
            }
        }

        // Tool functions
        function openKIChat() {
            alert('KI-Chat wird bald verf√ºgbar sein! ü§ñ');
        }

        function openAnalytics() {
            if (trialData && trialData.status === 'paid') {
                alert('Analytics-Feature l√§dt... üìä');
            } else {
                alert('Analytics ist ein Premium-Feature! üîí\n\nUpgrade f√ºr erweiterte Analytics.');
            }
        }

        function openSessionNotes() {
            alert('Session Notes werden bald verf√ºgbar sein! üìù');
        }

        function openCalendar() {
            if (trialData && trialData.status === 'paid') {
                alert('Kalender-Integration l√§dt... üìÖ');
            } else {
                alert('Kalender-Integration ist ein Premium-Feature! üîí\n\nUpgrade f√ºr volle Integration.');
            }
        }

        function inviteClient() {
            const email = prompt('Email-Adresse des Klienten:');
            if (email && email.trim()) {
                alert(`Einladung wird an ${email.trim()} gesendet! üìß`);
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('üöÄ Initializing dashboard...');
            
            // Show loading
            document.getElementById('loadingOverlay').classList.add('show');
            
            try {
                // Get coach data
                currentCoach = getCoachDataFromSources();
                
                if (!currentCoach) {
                    console.log('‚ùå No coach data found - redirecting to registration');
                    alert('Keine Anmeldedaten gefunden. Sie werden zur Registrierung weitergeleitet.');
                    window.location.href = 'coach-registration.html';
                    return;
                }
                
                console.log('‚úÖ Coach data loaded:', currentCoach);
                
                // Store coach data
                storeCoachData(currentCoach);
                
                // Clean URL parameters
                if (currentCoach.source === 'url') {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // Load trial data
                console.log('üîç Loading trial data...');
                await loadTrialData(currentCoach.id);
                
                // Update UI
                updateTrialBanner();
                updateDashboardContent();
                
                dashboardInitialized = true;
                console.log('‚úÖ Dashboard initialization complete');
                
            } catch (error) {
                console.error('‚ùå Dashboard initialization error:', error);
                alert('Fehler beim Laden des Dashboards. Bitte versuchen Sie es erneut.');
            } finally {
                // Hide loading
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }

        // Integration with trial manager
        function onTrialManagerReady() {
            console.log('üéØ Trial manager ready - integrating...');
            
            if (window.trialManager && currentCoach) {
                // Ensure trial manager has correct coach ID
                localStorage.setItem('coachId', currentCoach.id);
                localStorage.setItem('coachEmail', currentCoach.email);
                
                // Refresh trial status in trial manager
                if (typeof window.trialManager.refreshTrialStatus === 'function') {
                    window.trialManager.refreshTrialStatus();
                }
            }
        }

        // Listen for trial manager events
        document.addEventListener('trialDataUpdated', function(event) {
            console.log('üìä Trial data updated via event:', event.detail);
            trialData = event.detail;
            updateTrialBanner();
        });

        // Auto refresh trial data
        function setupAutoRefresh() {
            setInterval(async function() {
                if (currentCoach && currentCoach.id && dashboardInitialized) {
                    console.log('üîÑ Auto-refreshing trial data...');
                    await loadTrialData(currentCoach.id);
                    updateTrialBanner();
                }
            }, 5 * 60 * 1000); // Every 5 minutes
        }

        // DOM ready handler
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ Dashboard DOM ready');
            initializeDashboard();
            setupAutoRefresh();
            
            // Check for trial manager after a short delay
            setTimeout(onTrialManagerReady, 1000);
        });

        // Global functions for trial manager integration
        window.updateTrialStatus = function(data) {
            console.log('üîÑ External trial status update:', data);
            trialData = data;
            updateTrialBanner();
        };

        window.getCurrentCoach = function() {
            return currentCoach;
        };

        console.log('‚úÖ Dashboard script loaded successfully');
    </script>
</body>
</html>